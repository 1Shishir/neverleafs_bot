<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <title>Neverleafs Chatbot</title>
  <!-- Import Montserrat from Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    /* --- Color Variables --- */
    :root {
      --chat-bg: #fdfaef;           /* Chatbot background (light) */
      --border-color: #40442e;       /* Global/darker color for borders and headings */
      --header-bg: #40442e;          /* Header background (dark) */
      --header-text: #fdfaef;        /* Header text (light) */
      /* Button colors */
      --button-bg: #fdfaef;          /* Normal button background (light) */
      --button-text: #40442e;        /* Normal button text (dark) */
      --button-border: #40442e;      /* Normal button border (dark) */
      /* Hover colors (inverted) */
      --button-hover-bg: #40442e;     /* Button hover background (dark) */
      --button-hover-text: #fdfaef;   /* Button hover text (light) */
      --button-hover-border: #fdfaef; /* Button hover border (light) */
      /* Input fields */
      --input-bg: #fdfaef;
      --input-border: #40442e;
      --shadow: rgba(0, 0, 0, 0.15);
      --font-family: 'Montserrat', sans-serif;
    }
    
    /* --- Global Reset & Base Font Size --- */
    * {
      box-sizing: border-box;
    }
    html, body {
      height: 100%;
      margin: 0;
      font-family: var(--font-family);
      font-size: 1rem; /* Increased global font size */
      background: var(--chat-bg);
    }
    
    /* --- Chat Container --- */
    .chat-container {
      width: 70vw;
      height: 86vh; /* Increased by 20% from previous 72vh */
      margin: 5vh 15vw;
      display: flex;
      flex-direction: column;
      background: var(--chat-bg);
      border: 1px solid var(--border-color);
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 8px 20px var(--shadow);
    }
    
    /* --- Header (Reduced Padding) --- */
    .chat-header {
      background: var(--header-bg);
      color: var(--header-text);
      padding: 10px; /* Reduced from 15px */
      text-align: center;
      flex: 0 0 auto;
    }
    
    /* --- Chat Window --- */
    .chat-window {
      flex: 1;
      overflow-y: auto;
      padding: 15px;
      background: var(--chat-bg);
    }
    
    /* --- Module Container (hidden by default) --- */
    .module-container {
      display: none;
      width: 90%;
      margin: 10px auto;
      padding: 15px;
      background: var(--chat-bg);
      border: 1px solid var(--border-color);
      border-radius: 10px;
      max-height: 64vh; /* Increased by 20% from previous 53vh */
      overflow-y: auto;
    }
    
    /* Ensure all headings in modules use the darker color */
    .module-container h1,
    .module-container h2,
    .module-container h3 {
      color: var(--border-color);
    }
    
    /* General paragraph rule for modules */
    .module-container p {
      white-space: normal;
      word-break: break-word;
    }
    
    /* --- Footer --- */
    .chat-footer {
      background: var(--chat-bg);
      padding: 10px;
      flex: 0 0 auto;
    }
    
    /* --- Button Styles --- */
    button {
      border: 2px solid var(--button-border);
      border-radius: 10px;
      padding: 12px 25px;
      font-size: 0.9rem;
      cursor: pointer;
      background-color: var(--button-bg);
      color: var(--button-text);
      transition: background-color 0.3s, color 0.3s, border 0.3s, transform 0.2s;
    }
    button:hover {
      background-color: var(--button-hover-bg);
      color: var(--button-hover-text);
      border: 2px solid var(--button-hover-border);
      transform: translateY(-2px);
    }
    
    .module-buttons {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 10px;
    }
    
    /* --- Input Fields --- */
    input[type="text"] {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid var(--input-border);
      border-radius: 30px;
      font-size: 1rem;
      background: var(--input-bg);
      color: var(--input-border);
      transition: border-color 0.3s;
    }
    /* For inputs inside modules, use fit-content */
    .module-container input[type="text"] {
      display: inline-block;
      width: -moz-fit-content;
      width: -webkit-fit-content;
      width: fit-content;
    }
    /* Specifically for the Find Perfect Plant module, override to a fixed 400px */
    .find-plant-form input[type="text"] {
      width: 400px;
    }
    input[type="text"]:focus {
      border-color: var(--input-border);
      outline: none;
    }
    
    /* --- Chat Input Area --- */
    .chat-input-area {
      display: flex;
      gap: 10px;
    }
    #chat-input {
      flex: 1;
    }
    
    /* --- Chat Message Styles --- */
    .chat-message {
      margin: 10px 0;
      display: flex;
      align-items: flex-start;
    }
    .chat-message p {
      margin: 0;
      padding: 12px 15px;
      border-radius: 20px;
      max-width: 80%;
      line-height: 1.4;
    }
    .bot-message p {
      background-color: #BDC3C7;
      color: var(--border-color);
      align-self: flex-start;
    }
    .user-message {
      margin-left: auto;
      text-align: right;
      display: flex;
      justify-content: flex-end;
    }
    .user-message p {
      background-color: var(--header-bg);
      color: var(--header-text);
      align-self: flex-end;
    }
    
    /* --- Module-Specific Styles --- */
    /* Browse (Products) view */
    .category-select {
      margin-bottom: 25px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .category-select label {
      font-size: 1rem;
      color: var(--border-color);
    }
    .browse-desc {
      margin-bottom: 15px;
      color: var(--border-color);
    }
    /* Carousel container now scrolls horizontally in a single line */
    .carousel-container {
      display: flex;
      overflow-x: auto;
      gap: 20px;
      padding-bottom: 10px;
      flex-wrap: nowrap;
      justify-content: flex-start;
    }
    .carousel-container::-webkit-scrollbar {
      height: 8px;
    }
    .carousel-container::-webkit-scrollbar-thumb {
      background: var(--border-color);
      border-radius: 4px;
    }
    .product-card {
      background: var(--chat-bg);
      border: 1px solid var(--border-color);
      border-radius: 10px;
      width: 240px;
      flex-shrink: 0;
      box-shadow: 0 4px 12px var(--shadow);
      display: flex;
      flex-direction: column;
      transition: transform 0.2s;
    }
    .product-card:hover {
      transform: translateY(-4px);
    }
    .product-card img {
      width: 100%;
      aspect-ratio: 2 / 3;
      object-fit: cover;
      border-top-left-radius: 10px;
      border-top-right-radius: 10px;
    }
    .product-info {
      padding: 10px;
      flex-grow: 1;
      color: var(--border-color);
      white-space: normal;
      word-break: break-word;
    }
    .product-info h3 {
      margin: 5px 0;
      font-size: 1.1rem;
      white-space: normal;
      word-break: break-word;
    }
    .product-info p {
      margin: 4px 0;
      font-size: 0.9rem;
      white-space: normal;
      word-break: break-word;
    }
    .actions {
      padding: 10px;
      display: flex;
      justify-content: space-around;
      border-top: 1px solid var(--border-color);
    }
    
    /* Find Perfect Plant view */
    .find-plant-form {
      width: 100%;
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin-bottom: 20px;
    }
    .findplant-desc {
      margin-bottom: 15px;
      color: var(--border-color);
    }
    .find-plant-results {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      justify-content: center;
      margin-top: 20px;
    }
    .plant-card {
      background: var(--chat-bg);
      border: 1px solid var(--border-color);
      border-radius: 10px;
      width: 220px;
      flex-shrink: 0;
      box-shadow: 0 4px 12px var(--shadow);
      display: flex;
      flex-direction: column;
      transition: transform 0.2s;
      text-align: center;
      padding-bottom: 10px;
    }
    .plant-card:hover {
      transform: translateY(-4px);
    }
    .plant-card img {
      width: 100%;
      height: 150px;
      object-fit: cover;
      border-top-left-radius: 10px;
      border-top-right-radius: 10px;
    }
    .plant-info {
      padding: 10px;
      color: var(--border-color);
    }
    .plant-info h3 {
      margin: 5px 0;
      font-size: 1.1rem;
    }
    
    /* Maintenance view */
    .maintenance-input {
      width: 300px;
      padding: 12px 15px;
      border: 2px solid var(--input-border);
      border-radius: 30px;
      font-size: 1rem;
      background: var(--input-bg);
      color: var(--border-color);
      transition: border-color 0.3s;
    }
    .maintenance-input:focus {
      border-color: var(--input-border);
      outline: none;
    }
  </style>
</head>
<body>
  <div class="chat-container">
    <!-- Header -->
    <header class="chat-header">
      <h1>Neverleafs Chatbot</h1>
    </header>
    
    <!-- Chat Window -->
    <div class="chat-window" id="chat-window">
      <div class="chat-message bot-message">
        <p><span class="icon">üçÉ</span> Hey daar! Welkom bij NeverLeafs! Ik ben Leafie, jouw persoonlijke assistant. Waar kan ik je vandaag mee helpen?</p>
      </div>
    </div>
    
    <!-- Module Container (hidden by default) -->
    <div class="module-container" id="module-container"></div>
    
    <!-- Footer: Module Buttons and Chat Input -->
    <footer class="chat-footer">
      <div id="button-container" class="module-buttons">
        <button class="nav-button" onclick="showModule('products')">Bekijk Producten</button>
        <button class="nav-button" onclick="showModule('findPlant')">Vind de Perfecte Plant</button>
        <button class="nav-button" onclick="showModule('maintenance')">Leer Onderhoud</button>
        <button class="nav-button" onclick="showModule('checkOrderStatus')">Controleer Bestelstatus</button>
      </div>
      <div class="chat-input-area" id="chat-input-area">
        <input type="text" id="chat-input" placeholder="Typ je vraag...">
        <button id="chat-send-button" onclick="sendMessage()">Verstuur</button>
      </div>
    </footer>
  </div>
  
  <script>
    // API Base URL
    const API_BASE = 'http://127.0.0.1:8000';
    
    /* --- Module View Templates --- */
    const views = {
      // Browse (Products) view
      products: `
        <header>
          <h1>Bekijk Producten</h1>
          <button class="back-btn" onclick="hideModule()">Terug</button>
        </header>
        <p class="browse-desc">Kun je aangeven voor welke woonruimte je een kunstplant zoekt, zoals de slaapkamer, badkamer of woonkamer? En heb je een voorkeur voor een specifieke stijl, zoals modern of een andere sfeer? Laat ook even weten welke hoogte je ideaal vindt. Zo kan ik je de beste aanbevelingen geven!</p>
        <div class="category-select">
          <label>Kies een categorie:</label>
          <div id="category-buttons" style="display: flex; gap: 10px; flex-wrap: wrap;"></div>
        </div>
        <div id="productsCarousel" class="carousel-container">
          <!-- Product cards will be injected here -->
        </div>
        <div id="message"></div>
      `,
      
      // Find Perfect Plant view
      findPlant: `
        <header>
          <h1>Vind de Perfecte Plant</h1>
          <button class="back-btn" onclick="hideModule()">Terug</button>
        </header>
        <p class="findplant-desc">Kun je aangeven voor welke woonruimte je een kunstplant zoekt, zoals de slaapkamer, badkamer of woonkamer? En heb je een voorkeur voor een specifieke stijl, zoals modern of een andere sfeer? Laat ook even weten welke hoogte je ideaal vindt. Zo kan ik je de beste aanbevelingen geven!</p>
        <div class="find-plant-form">
          <input type="text" id="fp-location" placeholder="Woonruimte (slaapkamer, badkamer, woonkamer)">
          <input type="text" id="fp-size" placeholder="Gewenste grootte (klein, medium, groot)">
          <input type="text" id="fp-style" placeholder="Stijl (modern, etc.)">
          <button class="find-plant-btn" onclick="findPlant()">Vind mijn perfecte plant</button>
        </div>
        <div id="find-plant-results" class="find-plant-results"></div>
      `,
      
      // Maintenance view
      maintenance: `
        <header>
          <h1>Onderhoudstips</h1>
          <button class="back-btn" onclick="hideModule()">Terug</button>
        </header>
        <p>Kun je specifieker aangeven waar je vraag over het onderhoud van de kunstplant precies over gaat? Denk bijvoorbeeld aan stofvrij houden, het opfrissen van de bladeren of de beste plek om ze neer te zetten. Zo kan ik je gerichter advies geven!</p>
        <div style="margin-bottom:20px;">
          <h3>Algemene Onderhoudstip</h3>
          <div id="maintenance-buttons" style="display: flex; gap: 10px; flex-wrap: wrap;">
            <button class="maintenance-btn" data-topic="cleaning">Schoonmaken</button>
            <button class="maintenance-btn" data-topic="uv_protection">UV Bescherming</button>
            <button class="maintenance-btn" data-topic="sustainability">Duurzaamheid</button>
          </div>
        </div>
        <div style="margin-bottom:20px;">
          <h3>Plant-specifiek Onderhoud</h3>
          <input type="text" id="plant-name" class="maintenance-input" placeholder="Voer plantnaam in">
          <button id="get-plant-maintenance">Haal Onderhoudstip op</button>
        </div>
        <div id="maintenance-result" style="margin-top:20px;"></div>
      `,
      
      // Check Order Status view
      checkOrderStatus: `
        <header>
          <h1>Controleer Bestelstatus</h1>
          <button class="back-btn" onclick="hideModule()">Terug</button>
        </header>
        <p>Deze module is in aanbouw.</p>
      `
    };
    
    /* --- Module Functions --- */
    function showModule(moduleName) {
      const moduleContainer = document.getElementById('module-container');
      moduleContainer.innerHTML = views[moduleName] || `<p>Module niet gevonden.</p>`;
      moduleContainer.style.display = 'block';
      if (moduleName === 'products') {
        initProductsView();
      }
      if (moduleName === 'maintenance') {
        initMaintenanceView();
      }
      if (moduleName === 'findPlant') {
        // Set fixed width of 400px for inputs in the Find Perfect Plant module
        const inputs = document.querySelectorAll('.find-plant-form input[type="text"]');
        inputs.forEach(input => {
          input.style.width = '400px';
        });
      }
    }
    
    function hideModule() {
      document.getElementById('module-container').style.display = 'none';
    }
    
    /* --- Chat Functions --- */
    function appendChatMessage(sender, messageText) {
      const chatWindow = document.getElementById('chat-window');
      const messageDiv = document.createElement('div');
      messageDiv.classList.add('chat-message', sender === 'user' ? 'user-message' : 'bot-message');
      const icon = sender === 'user' ? 'üßë' : 'üçÉ';  // Bot replies include the leaf icon
      messageDiv.innerHTML = `<p><span class="icon">${icon}</span> ${messageText}</p>`;
      chatWindow.appendChild(messageDiv);
      chatWindow.scrollTop = chatWindow.scrollHeight;
    }
    
    async function sendMessage() {
      const inputField = document.getElementById('chat-input');
      const question = inputField.value.trim();
      if (!question) return;
      appendChatMessage('user', question);
      inputField.value = '';
      try {
        const response = await fetch(`${API_BASE}/query`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ query: question })
        });
        if (response.ok) {
          const data = await response.json();
          appendChatMessage('bot', data.response);
        } else {
          appendChatMessage('bot', 'Oeps, er is iets misgegaan!');
        }
      } catch (error) {
        console.error('Fout:', error);
        appendChatMessage('bot', 'Netwerkfout, probeer het later opnieuw.');
      }
    }
    
    /* --- Products View Functions --- */
    function initProductsView() {
      const categoryMapping = {
        "flowers": "Bloemen",
        "succulents": "Vetplanten",
        "trees": "Bomen",
        "indoor": "Binnen",
        "office": "Kantoor",
        "outdoors": "Buiten"
      };
      fetch(`${API_BASE}/products/categories`)
        .then(res => res.json())
        .then(data => {
          const categoryButtonsDiv = document.getElementById('category-buttons');
          categoryButtonsDiv.innerHTML = '';
          data.categories.forEach(cat => {
            const translatedCat = categoryMapping[cat.toLowerCase()] || cat;
            const btn = document.createElement('button');
            btn.className = 'nav-button';
            btn.textContent = translatedCat;
            btn.setAttribute('data-category', cat);
            btn.addEventListener('click', () => {
              fetch(`${API_BASE}/products/list?category=${encodeURIComponent(cat)}`)
                .then(res => res.json())
                .then(data => displayProducts(data.products))
                .catch(error => console.error('Fout bij het ophalen van producten:', error));
            });
            categoryButtonsDiv.appendChild(btn);
          });
        })
        .catch(error => console.error('Fout bij het ophalen van categorie√´n:', error));
    }
    
    function displayProducts(products) {
      const carousel = document.getElementById('productsCarousel');
      carousel.innerHTML = '';
      products.forEach(product => {
        const card = document.createElement('div');
        card.className = 'product-card';
        card.innerHTML = `
          <img src="${product.image}" alt="${product.name}">
          <div class="product-info">
            <h3>${product.name}</h3>
            <p><strong>Prijs:</strong> ${product.price}</p>
            <p><strong>Voorraad:</strong> ${product.stock}</p>
            <p><strong>Hoogte:</strong> ${product.height}</p>
          </div>
          <div class="actions">
            <button class="add-btn" data-id="${product.id}">Voeg toe aan winkelwagen</button>
            <button class="remove-btn" data-id="${product.id}" style="display: none;">Verwijder</button>
          </div>
        `;
        carousel.appendChild(card);
      });
      attachCartActions();
      // Auto-scroll the carousel container to the rightmost end
      carousel.scrollLeft = carousel.scrollWidth;
    }
    
    function attachCartActions() {
      document.querySelectorAll('.add-btn').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const productId = e.target.getAttribute('data-id');
          try {
            const res = await fetch(`${API_BASE}/cart/add`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ product_id: parseInt(productId), quantity: 1 })
            });
            const data = await res.json();
            showMessage(data.message);
            e.target.style.display = 'none';
            e.target.parentElement.querySelector('.remove-btn').style.display = 'inline-block';
          } catch (error) {
            console.error('Fout bij toevoegen aan winkelwagen:', error);
            showMessage('Fout bij toevoegen aan winkelwagen.');
          }
        });
      });
      document.querySelectorAll('.remove-btn').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const productId = e.target.getAttribute('data-id');
          try {
            const res = await fetch(`${API_BASE}/cart/remove`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ product_id: parseInt(productId) })
            });
            const data = await res.json();
            showMessage(data.message);
            e.target.style.display = 'none';
            e.target.parentElement.querySelector('.add-btn').style.display = 'inline-block';
          } catch (error) {
            console.error('Fout bij verwijderen uit winkelwagen:', error);
            showMessage('Fout bij verwijderen uit winkelwagen.');
          }
        });
      });
    }
    
    function showMessage(msg) {
      const msgDiv = document.getElementById('message');
      msgDiv.textContent = msg;
      setTimeout(() => { msgDiv.textContent = ''; }, 3000);
    }
    
    /* --- Maintenance View Functions --- */
    function initMaintenanceView() {
      document.querySelectorAll('#maintenance-buttons .maintenance-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const topic = btn.getAttribute('data-topic');
          fetch(`${API_BASE}/maintenance/${topic}`)
            .then(res => res.json())
            .then(data => {
              document.getElementById('maintenance-result').innerHTML = `<p>${data.message} ${data.tip}</p>`;
              // Auto-scroll the maintenance result container to the bottom
              const maintResult = document.getElementById('maintenance-result');
              maintResult.scrollTop = maintResult.scrollHeight;
            })
            .catch(error => {
              console.error('Fout bij ophalen onderhoudstip:', error);
              document.getElementById('maintenance-result').innerHTML = `<p>Fout bij ophalen tip.</p>`;
            });
        });
      });
      const plantBtn = document.getElementById('get-plant-maintenance');
      if (plantBtn) {
        plantBtn.addEventListener('click', () => {
          const plantName = document.getElementById('plant-name').value.trim();
          if (!plantName) {
            alert('Vul alstublieft een plantnaam in.');
            return;
          }
          fetch(`${API_BASE}/maintenance/plant/${plantName}`)
            .then(res => res.json())
            .then(data => {
              document.getElementById('maintenance-result').innerHTML = `<p>${data.message} ${data.tip}</p>`;
              const maintResult = document.getElementById('maintenance-result');
              maintResult.scrollTop = maintResult.scrollHeight;
            })
            .catch(error => {
              console.error('Fout bij ophalen plantonderhoudstip:', error);
              document.getElementById('maintenance-result').innerHTML = `<p>Fout bij ophalen tip.</p>`;
            });
        });
      }
    }
    
    /* --- Find Perfect Plant Functions --- */
    function findPlant() {
      const location = document.getElementById('fp-location').value.trim();
      const size = document.getElementById('fp-size').value.trim();
      const style = document.getElementById('fp-style').value.trim();
      if (!location || !size || !style) {
        alert('Vul alstublieft alle velden in met uw voorkeuren.');
        return;
      }
      fetch(`${API_BASE}/find_plant`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ location, size, style })
      })
      .then(res => res.json())
      .then(data => {
        displayPlantResults(data);
      })
      .catch(error => {
        console.error('Fout bij zoeken naar plant:', error);
        document.getElementById('find-plant-results').innerHTML = `<p>Fout bij zoeken naar plant.</p>`;
      });
    }
    
    function displayPlantResults(plants) {
      const resultsDiv = document.getElementById('find-plant-results');
      resultsDiv.innerHTML = '';
      if (plants.length === 0 || (plants[0] && plants[0].message)) {
        resultsDiv.innerHTML = `<p>${plants[0].message || 'Geen overeenkomsten gevonden.'}</p>`;
        return;
      }
      plants.forEach(plant => {
        const card = document.createElement('div');
        card.className = 'plant-card';
        const imageUrl = `${API_BASE}/static/images/${plant.image}`;
        card.innerHTML = `
          <img src="${imageUrl}" alt="${plant.name}">
          <div class="plant-info">
            <h3>${plant.name}</h3>
            <p><strong>Locatie:</strong> ${plant.location}</p>
            <p><strong>Grootte:</strong> ${plant.size}</p>
            <p><strong>Stijl:</strong> ${plant.style}</p>
          </div>
        `;
        resultsDiv.appendChild(card);
      });
      // Auto-scroll the find-plant-results container to the bottom
      resultsDiv.scrollTop = resultsDiv.scrollHeight;
    }
    
    /* --- Hide Module Container When Chat Input is Clicked --- */
    document.getElementById('chat-input').addEventListener('click', hideModule);
    
    /* --- Initialization on Page Load --- */
    document.addEventListener('DOMContentLoaded', () => {
      // The chat window already shows a welcome message.
      
      // Set up a MutationObserver on the module container to auto-scroll when new content is added
      const moduleContainer = document.getElementById('module-container');
      const observer = new MutationObserver(() => {
        moduleContainer.scrollTop = moduleContainer.scrollHeight;
      });
      observer.observe(moduleContainer, { childList: true, subtree: true });
    });
  </script>
</body>
</html>

